[gcode_macro START_BEEP_LOOP]
gcode:
    SET_GCODE_VARIABLE MACRO=BEEP_CONTROL VARIABLE=run_beep VALUE=1
    UPDATE_DELAYED_GCODE ID=beep_loop DURATION=0.1

[gcode_macro STOP_BEEP_LOOP]
gcode:
    SET_GCODE_VARIABLE MACRO=BEEP_CONTROL VARIABLE=run_beep VALUE=0
    UPDATE_DELAYED_GCODE ID=beep_loop DURATION=0

[gcode_macro BEEP_CONTROL]
variable_run_beep: 0
gcode:
    {% if printer["gcode_macro BEEP_CONTROL"].run_beep|int == 1 %}
        M300 S2000 P150
        G4 P150

        UPDATE_DELAYED_GCODE ID=beep_loop DURATION=1.0
    {% endif %}

[delayed_gcode beep_loop]
gcode:
    BEEP_CONTROL
