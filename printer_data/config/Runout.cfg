[gcode_macro START_BEEP_LOOP]
gcode:
    # Set the 'run_beep' variable to 1 (True) to start the loop
    SET_GCODE_VARIABLE MACRO=BEEP_CONTROL VARIABLE=run_beep VALUE=1
    # Start the delayed gcode with an initial duration to trigger the first beep
    UPDATE_DELAYED_GCODE ID=beep_loop DURATION=0.1

[gcode_macro STOP_BEEP_LOOP]
gcode:
    # Set the 'run_beep' variable to 0 (False) to stop the loop
    SET_GCODE_VARIABLE MACRO=BEEP_CONTROL VARIABLE=run_beep VALUE=0
    # Cancel any pending delayed gcode loop
    UPDATE_DELAYED_GCODE ID=beep_loop DURATION=0

[gcode_macro BEEP_CONTROL]
variable_run_beep: 0
gcode:
    {% if printer["gcode_macro BEEP_CONTROL"].run_beep|int == 1 %}
        # Add your beep command here (e.g., M300 or your specific buzzer macro)
        # Example using a custom BEEP macro defined elsewhere:
        BEEP DURATION=100 FREQ=2000

        # Update the delayed gcode to call itself again after a short delay
        # The duration here defines the time between the end of the last beep and the start of the next one
        UPDATE_DELAYED_GCODE ID=beep_loop DURATION=1.0
    {% endif %}

[delayed_gcode beep_loop]
# This only runs if called by UPDATE_DELAYED_GCODE
gcode:
    BEEP_CONTROL