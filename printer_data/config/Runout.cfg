# ==============================
# BEEPER PIN (Creality 4.2.2)
# ==============================
[output_pin BEEPER_pin]
pin: PC6
value: 0
shutdown_value: 0

# ==============================
# FILAMENT RUNOUT MACRO
# Starts alarm BEFORE pause
# ==============================
[gcode_macro _filament_runout]
variable_beep_alarm: 1
gcode:
    RESPOND TYPE=echo MSG="Filament runout detected!"
    M117 Filament Runout Detected

    # Start alarm loop BEFORE pausing
    UPDATE_DELAYED_GCODE ID=filament_beep_alarm DURATION=0.1

# ==============================
# ALARM LOOP — TRIPLE BEEP
# Runs continuously until filament_insert is called
# ==============================
[delayed_gcode filament_beep_alarm]
gcode:
    {% if printer["gcode_macro _filament_runout"].variable_beep_alarm == 1 %}
        # Triple beep pattern
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P120
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P70
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P120
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P70
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P120
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P300

        # Repeat loop
        UPDATE_DELAYED_GCODE ID=filament_beep_alarm DURATION=0.1
    {% endif %}

    # Only pause AFTER beeping starts
    PAUSE
    G91
    G1 Z10 F600
    G90
    G1 X5 Y0 F6000

# ==============================
# FILAMENT INSERT — STOPS ALARM
# ==============================
[gcode_macro filament_insert]
gcode:
    RESPOND TYPE=echo MSG="Filament inserted."

    # Stop alarm loop
    SET_GCODE_VARIABLE MACRO=_filament_runout VARIABLE=variable_beep_alarm VALUE=0
    
    # Stop beeper immediately
    SET_PIN PIN=BEEPER_pin VALUE=0

    RESPOND TYPE=echo MSG="Press RESUME to continue."
