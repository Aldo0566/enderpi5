

[gcode_macro _filament_runout]
variable_beep_alarm: 0
gcode:
    RESPOND TYPE=echo MSG="Filament runout detected! Insert filament and press RESUME."
    M117 Filament Runout Detected

    # Immediate pre-pause beep
    SET_PIN PIN=BEEPER_pin VALUE=0.5 CYCLE_TIME=0.001
    G4 P200
    SET_PIN PIN=BEEPER_pin VALUE=0
    G4 P50
    SET_PIN PIN=BEEPER_pin VALUE=0.5 CYCLE_TIME=0.001
    G4 P200
    SET_PIN PIN=BEEPER_pin VALUE=0

    # Start beep loop variable
    SET_GCODE_VARIABLE MACRO=_filament_runout VARIABLE=variable_beep_alarm VALUE=1
    UPDATE_DELAYED_GCODE ID=filament_beep_loop DURATION=0.4

    # Pause and park toolhead safely
    PAUSE
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E-2 F2100
    {% endif %}
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z10
    {% endif %}
    G90
    {% if "xy" in printer.toolhead.homed_axes %}
        G1 X5 Y0 F6000
    {% endif %}

[delayed_gcode filament_beep_loop]
gcode:
    {% if printer.gcode_macro._filament_runout.variable_beep_alarm == 1 %}
        SET_PIN PIN=BEEPER_pin VALUE=0.5 CYCLE_TIME=0.001
        G4 P150
        SET_PIN PIN=BEEPER_pin VALUE=0
        UPDATE_DELAYED_GCODE ID=filament_beep_loop DURATION=0.4
    {% endif %}

[gcode_macro filament_insert]
gcode:
    RESPOND TYPE=echo MSG="Filament inserted."
    SET_GCODE_VARIABLE MACRO=_filament_runout VARIABLE=variable_beep_alarm VALUE=0
    SET_PIN PIN=BEEPER_pin VALUE=0
    RESPOND TYPE=echo MSG="Press RESUME to continue."
