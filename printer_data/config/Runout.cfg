# -----------------------------
# Filament Runout Configuration
# ----------------------------
[respond]

[filament_motion_sensor encoder_sensor]
switch_pin: ^PA4
detection_length: 7.0
extruder: extruder
pause_on_runout: true
runout_gcode: _filament_runout
insert_gcode: filament_insert

###################################################
# MAIN RUNOUT MACRO — STARTS TRIPLE ALARM BEFORE PAUSE
###################################################
[gcode_macro _filament_runout]
variable_beep_alarm: 1
gcode:
    RESPOND TYPE=echo MSG="Filament runout detected! Insert filament and press RESUME."
    M117 Filament Runout Detected

    # Start repeating triple-alarm BEFORE PAUSE
    UPDATE_DELAYED_GCODE ID=filament_beep_alarm DURATION=0.1

    [delayed_gcode filament_beep_alarm]
gcode:
    {% if printer.gcode_macro._filament_runout.variable_beep_alarm == 1 %}
        # Triple beep sequence
        SET_PIN PIN=BEEPER_pin VALUE=1.0 CYCLE_TIME=0.001
        G4 P100
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P50
        SET_PIN PIN=BEEPER_pin VALUE=1.0 CYCLE_TIME=0.001
        G4 P100
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P50
        SET_PIN PIN=BEEPER_pin VALUE=1.0 CYCLE_TIME=0.001
        G4 P100
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P300   # short pause before repeating sequence

        # Schedule next triple-beep loop
        UPDATE_DELAYED_GCODE ID=filament_beep_alarm DURATION=0.1
    {% endif %}

    # Pause and park toolhead safely
    PAUSE
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E-2 F2100
    {% endif %}
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z10
    {% endif %}
    G90
    {% if "xy" in printer.toolhead.homed_axes %}
        G1 X5 Y0 F6000
    {% endif %}

###################################################
# TRIPLE-BEEP ALARM LOOP — REPEATS CONTINUOUSLY
###################################################
#[delayed_gcode filament_beep_alarm]
#gcode:
#    {% if printer.gcode_macro._filament_runout.variable_beep_alarm == 1 %}
#        # Triple beep sequence
#       SET_PIN PIN=BEEPER_pin VALUE=1.0 CYCLE_TIME=0.001
#        G4 P100
#        SET_PIN PIN=BEEPER_pin VALUE=0
#        G4 P50
#        SET_PIN PIN=BEEPER_pin VALUE=1.0 CYCLE_TIME=0.001
#        G4 P100
#        SET_PIN PIN=BEEPER_pin VALUE=0
#        G4 P50
#        SET_PIN PIN=BEEPER_pin VALUE=1.0 CYCLE_TIME=0.001
#        G4 P100
#        SET_PIN PIN=BEEPER_pin VALUE=0
#        G4 P300   # short pause before repeating sequence

#        # Schedule next triple-beep loop
#        UPDATE_DELAYED_GCODE ID=filament_beep_alarm DURATION=0.1
#    {% endif %}

###################################################
# FILAMENT INSERT — STOPS ALARM
###################################################
[gcode_macro filament_insert]
gcode:
    RESPOND TYPE=echo MSG="Filament inserted."

    # Stop repeating alarm
    SET_GCODE_VARIABLE MACRO=_filament_runout VARIABLE=variable_beep_alarm VALUE=0

    # Safety temperature check
    {% set TARGET = printer.configfile.config.extruder.min_extrude_temp|float %}
    {% set TEMP = printer.extruder.temperature|float %}
    {% if TEMP < TARGET %}
        RESPOND TYPE=error MSG="Heat nozzle before continuing."
    {% else %}
        RESPOND TYPE=echo MSG="Press RESUME to continue."
    {% endif %}

    SET_IDLE_TIMEOUT TIMEOUT=900

###################################################
# OPTIONAL HEAT & RESUME MACRO
###################################################
[gcode_macro HEAT_AND_RESUME]
description: Heat the extruder and resume print when target is reached
gcode:
    {% set min_target = printer.configfile.config.extruder.min_extrude_temp|float %}
    {% set TARGET = params.TARGET|default(min_target)|float %}
    M109 S{TARGET}
    RESPOND TYPE=echo MSG="Temperature reached. Resuming print."
    RESUME
