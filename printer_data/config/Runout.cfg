# Need this to send console messages
[respond]

#[filament_switch_sensor runout_sensor]
#pause_on_runout: False # This needs to be false to use runout_gcode
#runout_gcode:
#   _filament_runout
#insert_gcode:
#   _filament_insert
#switch_pin:P4A

[filament_motion_sensor encoder_sensor]
switch_pin: ^PA4
detection_length: 7.0 # The recommended default for V1 is 7mm
extruder: extruder
pause_on_runout: False
runout_gcode: 
  _filament_runout
insert_gcode:
   _filament_insert

#[gcode_macro _filament_runout]
#gcode:
    #SET_IDLE_TIMEOUT TIMEOUT=10800 # Set idle_timeout to 3hrs
    #M104 S0 # turn off the hotend
    #SAVE_GCODE_STATE is not required as PAUSE does this automatically
    # See here: https://www.klipper3d.org/G-Codes.html#pause
    #BASE_PAUSE
    #G91 # Relative positioning
    #G1 E-10 F2100 # Retract 10mm of filament
    #G1 Z10 # Move Z up 10mm from current position
    #G90 # Absolute positioning
    #G1 X5 Y0 F6000 # Park at the coordinates you said you wanted
    #M106 S0 # Disable the part cooling fan
    #UPDATE_DELAYED_GCODE ID=runout_wait DURATION=300

#[gcode_macro _filament_runout]
#gcode:
#    RESPOND TYPE=info MSG="Filament runout detected. Pausing print..."
#    SAVE_GCODE_STATE NAME=runout_state
#    SET_IDLE_TIMEOUT TIMEOUT=10800
#    G91
#    G1 E-10 F2100
#    G1 Z10
#    G90
#    G1 X5 Y0 F6000
#    M106 S0
#    UPDATE_DELAYED_GCODE ID=runout_wait DURATION=300
#    PAUSE


[gcode_macro _filament_runout]
#description: Pause the actual running print
#rename_existing: Pause Base
gcode:
    ##### set defaults #####
    {% set x = params.X|default(5) %}      #edit to your park position
    {% set y = params.Y|default(0) %}      #edit to your park position
    {% set z = params.Z|default(10)|float %} #edit to your park position
    {% set e = params.E|default(1) %}        #edit to your retract length
    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set lift_z = z|abs %}
    {% if act_z < (max_z - lift_z) %}
        {% set z_safe = lift_z %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    ##### end of definitions #####
    PAUSE_BASE
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E-{e} F2100
    {% else %}
        {action_respond_info("Extruder not hot enough")}
    {% endif %}
    {% if "xyz" in printer.toolhead.homed_axes %}    
    G1 Z{z_safe}
    G90
    G1 X{x} Y{y} F6000
    {% else %}
    {action_respond_info("Printer not homed")}
    {% endif %}
    #UPDATE_DELAYED_GCODE ID=runout_wait DURATION=300
    #PAUSE
    
#[delayed_gcode runout_wait]
#gcode:
    # Honestly you probably shouldn't keep the hotend heated for 5 minutes as it's
    # definitely going to leak a bunch of filament during that time, but anyway
    #M104 S0 # turn off the hotend

[gcode_macro filament_insert]
gcode:
    # Get the extruder min_extrude_temp (will be 150 if not defined)
    {% set TARGET = printer.configfile.config.extruder.min_extrude_temp|float %}
    # Get the current extruder temp
    {% set TEMP = printer.extruder.temperature|float %}
    {% if TEMP < TARGET %}
        RESPOND TYPE=error MSG="Please heat the extruder before continuing."
    {% else %}
        RESPOND TYPE=error MSG="Press RESUME to continue."
    {% endif %}
    SET_IDLE_TIMEOUT TIMEOUT=900 # Set idle_timeout to 15 minutes


# Use this macro to heat the extruder and then resume like so:
# 
# HEAT_AND_RESUME TARGET=220
# 
[gcode_macro HEAT_AND_RESUME]
description: Heat the extruder and resume print when target is reached
gcode:
    # Get the extruder min_extrude_temp (will be 150 if not defined)
    {% set min_target = printer.configfile.config.extruder.min_extrude_temp|float %}
    # Get the target from params or set it to min_target if none is given
    {% set TARGET = params.TARGET|default(min_target)|float %}
    # Heat the extruder and wait for the target to be reached
    M109 S{TARGET}
    # Notify that print is resuming
    RESPOND TYPE=error MSG="Temperature reached. Resuming print."
    # Resume print when target is reached
    # This will automatically restore to the pre-PAUSE position
    # See here: https://www.klipper3d.org/G-Codes.html#resume
    RESUME