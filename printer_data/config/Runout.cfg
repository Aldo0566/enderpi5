# -----------------------------
# Filament Runout Configuration
# ----------------------------
[respond]

[filament_motion_sensor encoder_sensor]
switch_pin: ^PA4
detection_length: 7.0
extruder: extruder
pause_on_runout: true
runout_gcode: _filament_runout
insert_gcode: filament_insert


# ==============================
# BEEPER PIN (Creality 4.2.2)
# ==============================
[output_pin BEEPER_pin]
pin: PC6
value: 0
shutdown_value: 0

# ==============================
# FILAMENT RUNOUT MACRO
# Starts alarm BEFORE pause (immediate test tone included)
# ==============================
[gcode_macro _filament_runout]
variable_beep_alarm: 1
gcode:
    RESPOND TYPE=echo MSG="Filament runout detected!"
    M117 Filament Runout Detected
    UPDATE_DELAYED_GCODE ID=filament_beep_alarm DURATION=0.1

# ==============================
# ALARM LOOP — TRIPLE BEEP (repeats)
# Runs continuously until filament_insert is called
# ==============================
[delayed_gcode filament_beep_alarm]
gcode:
    {% if printer["gcode_macro _filament_runout"].variable_beep_alarm == 1 %}
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P120
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P70
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P120
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P70
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P120
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P300

        UPDATE_DELAYED_GCODE ID=filament_beep_alarm DURATION=0.1
    {% endif %}

    PAUSE
    G91
    G1 Z10 F600
    G90
    G1 X5 Y0 F6000

# ==============================
# FILAMENT INSERT — STOPS ALARM
# ==============================
[gcode_macro filament_insert]
gcode:
    RESPOND TYPE=echo MSG="Filament inserted."

    SET_GCODE_VARIABLE MACRO=_filament_runout VARIABLE=variable_beep_alarm VALUE=0
    
    SET_PIN PIN=BEEPER_pin VALUE=0

    RESPOND TYPE=echo MSG="Press RESUME to continue."


