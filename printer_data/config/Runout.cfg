##################################################
# Filament Runout Alarm Macro — Interruptible
##################################################

[filament_motion_sensor encoder_sensor]
switch_pin: ^PA4
detection_length: 7.0
extruder: extruder
pause_on_runout: true
runout_gcode: _filament_runout
insert_gcode: filament_insert

[output_pin BEEPER_pin]
pin: PC6
value: 0
shutdown_value: 0

##################################################
# Filament Runout Macro — starts alarm + pause
##################################################
[gcode_macro _filament_runout]
gcode:
    RESPOND TYPE=echo MSG="Filament runout detected! Insert filament to stop alarm."
    M117 Filament Runout Detected

    # Activate alarm loop
    SET_GCODE_VARIABLE MACRO=filament_beep_loop VARIABLE=alarm_active VALUE=1
    UPDATE_DELAYED_GCODE ID=filament_beep_loop DURATION=0.1

    # Pause and park
    PAUSE

##################################################
# Delayed G-code — 3-short → 2-long beep pattern
##################################################
[gcode_macro filament_beep_loop]
variable_alarm_active: 0
gcode:
    {% if printer.gcode_macro.filament_beep_loop.alarm_active == 1 %}
        # 3 short beeps
        M300 S1000 P150
        M300 S1000 P150
        M300 S1000 P150
        G4 P600
        # 2 long beeps
        M300 S1500 P150
        M300 S1500 P150
        G4 P600
        # Repeat loop every 0.5s
        UPDATE_DELAYED_GCODE ID=filament_beep_loop DURATION=0.5
    {% else %}
        SET_PIN PIN=BEEPER_pin VALUE=0
    {% endif %}

##################################################
# Filament Insert Macro — stops alarm
##################################################
[gcode_macro filament_insert]
gcode:
    RESPOND TYPE=echo MSG="Filament inserted."
    SET_GCODE_VARIABLE MACRO=filament_beep_loop VARIABLE=alarm_active VALUE=0
    SET_PIN PIN=BEEPER_pin VALUE=0
    RESPOND TYPE=echo MSG="Press RESUME to continue."

##################################################
# STOP_BEEP — UI button or console stop
##################################################
[gcode_macro STOP_BEEP]
description: Stop alarm without resuming print
gcode:
    SET_GCODE_VARIABLE MACRO=filament_beep_loop VARIABLE=alarm_active VALUE=0
    SET_PIN PIN=BEEPER_pin VALUE=0
    RESPOND TYPE=echo MSG="Beep stopped (print still paused)."
