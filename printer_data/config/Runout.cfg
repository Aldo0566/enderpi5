# ==============================
# FILAMENT SENSOR
# ==============================
[filament_motion_sensor encoder_sensor]
switch_pin: ^PA4
detection_length: 7.0
extruder: extruder
pause_on_runout: true
runout_gcode: _filament_runout
insert_gcode: filament_insert

# ==============================
# BEEPER PIN
# ==============================
[output_pin BEEPER_pin]
pin: PC6
value: 0
shutdown_value: 0

# ==============================
# ALARM LOOP — continuously runs, independent of pause
# ==============================
[delayed_gcode filament_beep_loop]
gcode:
    {% if printer.gcode_macro._filament_runout.alarm_active == 1 %}
        # Triple beep
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P150
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P70
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P150
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P70
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P150
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P300
    {% endif %}

    # Schedule next run every 0.1s
    UPDATE_DELAYED_GCODE ID=filament_beep_loop DURATION=0.1

# ==============================
# FILAMENT RUNOUT MACRO
# ==============================
[gcode_macro _filament_runout]
alarm_active: 0
gcode:
    RESPOND TYPE=echo MSG="Filament runout detected! Insert filament to stop alarm."
    M117 Filament Runout Detected

    # Immediate pre-pause beep
    SET_PIN PIN=BEEPER_pin VALUE=1
    G4 P200
    SET_PIN PIN=BEEPER_pin VALUE=0
    G4 P50
    SET_PIN PIN=BEEPER_pin VALUE=1
    G4 P200
    SET_PIN PIN=BEEPER_pin VALUE=0

    # Activate the alarm loop
    SET_GCODE_VARIABLE MACRO=_filament_runout VARIABLE=alarm_active VALUE=1
    RUN_MACRO NAME=filament_beep_loop

    # Pause and park toolhead safely
    PAUSE
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E-2 F2100
    {% endif %}
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z10
    {% endif %}
    G90
    {% if "xy" in printer.toolhead.homed_axes %}
        G1 X5 Y0 F6000
    {% endif %}

# ==============================
# FILAMENT INSERT MACRO
# ==============================
[gcode_macro filament_insert]
gcode:
    RESPOND TYPE=echo MSG="Filament inserted."
    # Stop alarm
    SET_GCODE_VARIABLE MACRO=_filament_runout VARIABLE=alarm_active VALUE=0
    SET_PIN PIN=BEEPER_pin VALUE=0
    RESPOND TYPE=echo MSG="Press RESUME to continue."
# ==============================
# Filament Runout Sensor
# ==============================
[filament_motion_sensor encoder_sensor]
switch_pin: ^PA4
detection_length: 7.0
extruder: extruder
pause_on_runout: true
runout_gcode: _filament_runout
insert_gcode: filament_insert

# ==============================
# BEEPER PIN
# ==============================
[output_pin BEEPER_pin]
pin: PC6
value: 0
shutdown_value: 0

# ==============================
# ALARM LOOP (runs independently)
# ==============================

[gcode_macro alarm_loop]
# Flag variable to control continuous beeping
variable_beep_alarm: 0
gcode:
    {% if printer.gcode_macro.alarm_loop.variable_beep_alarm == 1 %}
        # Triple beep sequence
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P150
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P70
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P150
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P70
        SET_PIN PIN=BEEPER_pin VALUE=1
        G4 P150
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P300
        # Schedule next beep loop
        UPDATE_DELAYED_GCODE ID=alarm_loop DURATION=0.1
    {% endif %}

# ==============================
# FILAMENT RUNOUT MACRO
# ==============================
[gcode_macro _filament_runout]
gcode:
    RESPOND TYPE=echo MSG="Filament runout detected! Insert filament to stop alarm."
    M117 Filament Runout Detected

    # Continuous beep loop until filament inserted
    {% for i in range(99999) %}
        {% if printer.filament_motion_sensor.encoder_sensor.filament_detected %}
            RESPOND TYPE=echo MSG="Filament detected — stopping alarm."
            {% break %}
        {% endif %}

        # Beep pulse
        SET_PIN PIN=BEEPER_pin VALUE=0.5 CYCLE_TIME=0.001
        G4 P150
        SET_PIN PIN=BEEPER_pin VALUE=0
        G4 P150
    {% endfor %}

    # Now pause normally
    PAUSE
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E-2 F2100
    {% endif %}
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z10
    {% endif %}
    G90
    {% if "xy" in printer.toolhead.homed_axes %}
        G1 X5 Y0 F6000
    {% endif %}
# ==============================
# FILAMENT INSERT MACRO
# ==============================
[gcode_macro filament_insert]
gcode:
    RESPOND TYPE=echo MSG="Filament inserted."
    # Stop continuous alarm
    SET_GCODE_VARIABLE MACRO=alarm_loop VARIABLE=variable_beep_alarm VALUE=0
    SET_PIN PIN=BEEPER_pin VALUE=0
    RESPOND TYPE=echo MSG="Press RESUME to continue."
